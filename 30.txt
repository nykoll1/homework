CREATE TABLE categories (
    cat_id SERIAL PRIMARY KEY,
    title VARCHAR(50)
);

CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    title VARCHAR(50),
    price NUMERIC,
    quantity INT,
    cat_id INT REFERENCES categories(cat_id)
);

CREATE VIEW all_data AS
SELECT title, price, quantity
FROM products;

CREATE VIEW expensive_products AS
SELECT * FROM products WHERE price > 1500;

CREATE VIEW joined_view AS
SELECT p.title, p.price, p.quantity, c.title AS category FROM products p
JOIN categories c ON c.cat_id = p.cat_id;

CREATE OR REPLACE VIEW expensive_products AS
SELECT * FROM products WHERE price > 1000;

CREATE OR REPLACE VIEW all_data AS
SELECT product_id, title, price, quantity
FROM products;

DROP VIEW IF EXISTS all_data;
DROP VIEW IF EXISTS expensive_products;
DROP VIEW IF EXISTS joined_view;

CREATE PROCEDURE delete_product(p_id INT)
LANGUAGE plpgsql
AS $$
BEGIN
    DELETE FROM products WHERE product_id = p_id;
END;
$$;

CREATE PROCEDURE change_price(p_id INT, new_price NUMERIC)
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE products
    SET price = new_price
    WHERE product_id = p_id;
END;
$$;

ALTER TABLE products ADD COLUMN updated_at TIMESTAMP;

CREATE OR REPLACE FUNCTION set_updated_time()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$;

CREATE TRIGGER update_time_trigger
BEFORE UPDATE ON products
FOR EACH ROW
EXECUTE FUNCTION set_updated_time();
